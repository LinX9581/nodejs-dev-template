<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%- title.replace(/</g, '&lt;').replace(/>/g, '&gt;') %> <%= version %> - DevOps Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/bootstrap-icons.css">
    
    <!-- DataTables Bootstrap 5 CSS -->
    <link rel="stylesheet" href="./css/datatables.bootstrap5.min.css">
    
    <!-- JetBrains Mono Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- è‡ªè¨‚æ¨£å¼ -->
    <link rel="stylesheet" href="./css/style.css">
</head>

<body>
    <div class="container-fluid py-4">
        <div class="main-container p-4">
            <!-- Header -->
            <div class="row">
                <div class="col-12">
                    <h1 class="glow-effect mb-4">
                        <i class="bi bi-terminal"></i>
                        <%- title.replace(/</g, '&lt;').replace(/>/g, '&gt;') %> <%= version %>
                    </h1>
                </div>
            </div>

            <!-- Stats Info -->
            <div class="row">
                <div class="col-12">
                    <div class="stats-card">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h6><i class="bi bi-clock"></i> TIMESTAMP</h6>
                                <code><%= today %></code>
                            </div>
                            <div class="col-md-3">
                                <h6><i class="bi bi-git"></i> VERSION</h6>
                                <code>v<%= version %></code>
                            </div>
                            <div class="col-md-3">
                                <h6><i class="bi bi-database"></i> PROJECTS</h6>
                                <code id="project-count">--loading--</code>
                            </div>
                            <div class="col-md-3">
                                <h6><i class="bi bi-graph-up-arrow"></i> TRENDS</h6>
                                <code id="trend-count">--loading--</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="row">
                <!-- GitHub Stars Chart -->
                <div class="col-xl-6 col-lg-12">
                    <div class="chart-card" data-title="GITHUB_STARS">
                        <h3 class="card-title">
                            <i class="bi bi-star-fill text-warning"></i>
                            GitHub Stars Analytics
                        </h3>
                        
                        <div id="chart-loading-1" class="loading-spinner">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                        
                        <canvas id="starsChart" style="display: none;"></canvas>
                    </div>
                </div>

                <!-- DevOps Trends Chart -->
                <div class="col-xl-6 col-lg-12">
                    <div class="chart-card" data-title="DEVOPS_TRENDS">
                        <h3 class="card-title">
                            <i class="bi bi-graph-up text-info"></i>
                            DevOps Trends 2024
                        </h3>
                        
                        <div id="chart-loading-2" class="loading-spinner">
                            <div class="spinner-border text-info" role="status"></div>
                        </div>
                        
                        <canvas id="trendsChart" style="display: none;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tables Section -->
            <div class="row">
                <!-- GitHub Projects Table -->
                <div class="col-xl-6 col-lg-12">
                    <div class="table-card" data-title="PROJECTS_DATA">
                        <h3 class="card-title">
                            <i class="bi bi-github text-light"></i>
                            GitHub Projects Database
                        </h3>
                        
                        <div id="table-loading-1" class="loading-spinner">
                            <div class="spinner-border text-success" role="status"></div>
                        </div>
                        
                        <div id="table-container-1" style="display: none;">
                            <table id="projectsTable" class="table table-dark table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Project</th>
                                        <th>Stars</th>
                                        <th>Lang</th>
                                        <th>Link</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- DevOps Trends Table -->
                <div class="col-xl-6 col-lg-12">
                    <div class="table-card" data-title="TRENDS_DATA">
                        <h3 class="card-title">
                            <i class="bi bi-bar-chart text-light"></i>
                            DevOps Trends Database
                        </h3>
                        
                        <div id="table-loading-2" class="loading-spinner">
                            <div class="spinner-border text-warning" role="status"></div>
                        </div>
                        
                        <div id="table-container-2" style="display: none;">
                            <table id="trendsTable" class="table table-dark table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Growth</th>
                                        <th>Adoption</th>
                                        <th>Trend</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Alert -->
            <div id="error-alert" class="alert alert-danger d-none" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <strong>ERROR:</strong> <span id="error-message"></span>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="./js/bootstrap.bundle.min.js"></script>
    <script src="./js/jquery.min.js"></script>
    <script src="./js/chart.umd.min.js"></script>
    <script src="./js/datatables.min.js"></script>
    <script src="./js/datatables.bootstrap5.min.js"></script>

    <script>
        // ðŸŽ¨ å·¥ç¨‹å¸«é¢¨æ ¼é…è‰²
        const chartColors = {
            github: ['#f85149', '#ff7b72', '#ffa198', '#ffbdbe', '#ffc1cc'],
            trends: ['#7c3aed', '#8b5cf6', '#a78bfa', '#c4b5fd', '#ddd6fe'],
            success: '#238636',
            warning: '#d29922',
            info: '#58a6ff',
            danger: '#f85149'
        };

        let starsChart = null;
        let trendsChart = null;
        let projectsTable = null;
        let trendsTable = null;

        // ðŸ“¡ ç²å– GitHub å°ˆæ¡ˆè³‡æ–™
        const fetchProjects = async () => {
            const response = await fetch('/api/devops-projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const { status, data, message } = await response.json();
            if (status !== 'success') throw new Error(message);
            return data;
        };

        // ðŸ“Š ç²å– DevOps è¶¨å‹¢è³‡æ–™
        const fetchTrends = async () => {
            const response = await fetch('/api/devops-trends', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const { status, data, message } = await response.json();
            if (status !== 'success') throw new Error(message);
            return data;
        };

        // ðŸ“Š åˆå§‹åŒ– GitHub Stars åœ–è¡¨
        const initStarsChart = (projects) => {
            const sortedProjects = [...projects].sort((a, b) => b.stars - a.stars).slice(0, 8);
            const ctx = $('#starsChart')[0].getContext('2d');
            
            starsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedProjects.map(p => p.name),
                    datasets: [{
                        label: 'â­ GitHub Stars',
                        data: sortedProjects.map(p => p.stars),
                        backgroundColor: chartColors.github,
                        borderColor: '#f85149',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: false },
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                color: '#7d8590',
                                font: { family: 'JetBrains Mono' },
                                callback: value => value.toLocaleString()
                            },
                            grid: { color: '#30363d' }
                        },
                        x: {
                            ticks: { 
                                color: '#7d8590',
                                font: { family: 'JetBrains Mono' }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        };

        // ðŸ“ˆ åˆå§‹åŒ– DevOps Trends åœ–è¡¨
        const initTrendsChart = (trends) => {
            const ctx = $('#trendsChart')[0].getContext('2d');
            
            trendsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: trends.map(t => t.category),
                    datasets: [{
                        label: 'ðŸ“ˆ Growth %',
                        data: trends.map(t => t.growth_percentage),
                        backgroundColor: chartColors.trends,
                        borderColor: '#30363d',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#c9d1d9',
                                font: { family: 'JetBrains Mono', size: 10 }
                            }
                        }
                    }
                }
            });
        };

        // ðŸ“‹ åˆå§‹åŒ–å°ˆæ¡ˆè¡¨æ ¼
        const initProjectsTable = (projects) => {
            const tableData = projects.map(project => [
                `<strong>${project.name}</strong>`,
                `<span class="stars-count">${project.stars.toLocaleString()}</span>`,
                `<span class="language-badge" style="background-color: ${getLanguageColor(project.language)}">${project.language}</span>`,
                `<a href="${project.url}" target="_blank" class="project-link">
                    <i class="bi bi-box-arrow-up-right"></i>
                </a>`
            ]);

            projectsTable = $('#projectsTable').DataTable({
                data: tableData,
                order: [[1, 'desc']],
                pageLength: 8,
                searching: false,
                info: false,
                lengthChange: false,
                language: { paginate: { previous: "â€¹", next: "â€º" } }
            });
        };

        // ðŸ“Š åˆå§‹åŒ–è¶¨å‹¢è¡¨æ ¼
        const initTrendsTable = (trends) => {
            const tableData = trends.map(trend => [
                `<strong>${trend.category}</strong>`,
                `<span class="growth-percentage">+${trend.growth_percentage}%</span>`,
                `${trend.adoption_rate}%`,
                `<span class="trend-indicator trend-${trend.trend}">${trend.trend.toUpperCase()}</span>`
            ]);

            trendsTable = $('#trendsTable').DataTable({
                data: tableData,
                order: [[1, 'desc']],
                pageLength: 8,
                searching: false,
                info: false,
                lengthChange: false,
                language: { paginate: { previous: "â€¹", next: "â€º" } }
            });
        };

        // ðŸŽ¨ ç¨‹å¼èªžè¨€é¡è‰²
        const getLanguageColor = (language) => {
            const colors = {
                'Go': '#00ADD8',
                'Python': '#3776AB',
                'TypeScript': '#3178C6',
                'Java': '#ED8B00',
                'JavaScript': '#F7DF1E'
            };
            return colors[language] || '#6c757d';
        };

        // ðŸ‘ï¸ UI æŽ§åˆ¶
        const hideLoading = (type) => {
            if (type === 'charts') {
                $('#chart-loading-1, #chart-loading-2').fadeOut(300);
                $('#starsChart, #trendsChart').fadeIn(500);
            } else if (type === 'tables') {
                $('#table-loading-1, #table-loading-2').fadeOut(300);
                $('#table-container-1, #table-container-2').fadeIn(500);
            }
        };

        const showError = (message) => {
            $('.loading-spinner').hide();
            $('#error-message').text(message);
            $('#error-alert').removeClass('d-none');
        };

        const updateCounts = (projects, trends) => {
            $('#project-count').text(`${projects.length} repos`);
            $('#trend-count').text(`${trends.length} categories`);
        };

        // ðŸ§¹ æ¸…ç†è³‡æº
        const cleanup = () => {
            starsChart?.destroy();
            trendsChart?.destroy();
            projectsTable?.destroy();
            trendsTable?.destroy();
        };

        // ðŸ” ç­‰å¾… Chart.js è¼‰å…¥
        const waitForChart = () => {
            return new Promise((resolve) => {
                if (typeof Chart !== 'undefined') {
                    resolve();
                } else {
                    setTimeout(() => waitForChart().then(resolve), 100);
                }
            });
        };

        // ðŸš€ ä¸»æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
        const initApp = async () => {
            try {
                // ä¸¦è¡Œç²å–è³‡æ–™
                const [projects, trends] = await Promise.all([
                    fetchProjects(),
                    fetchTrends()
                ]);
                
                // æ›´æ–°è¨ˆæ•¸å™¨
                updateCounts(projects, trends);
                
                // åˆå§‹åŒ–åœ–è¡¨
                await Promise.all([
                    new Promise(resolve => { initStarsChart(projects); resolve(); }),
                    new Promise(resolve => { initTrendsChart(trends); resolve(); })
                ]);
                
                // åˆå§‹åŒ–è¡¨æ ¼
                await Promise.all([
                    new Promise(resolve => { initProjectsTable(projects); resolve(); }),
                    new Promise(resolve => { initTrendsTable(trends); resolve(); })
                ]);
                
                // éš±è—è¼‰å…¥ç•«é¢
                setTimeout(() => {
                    hideLoading('charts');
                    hideLoading('tables');
                }, 800);
                
            } catch (error) {
                console.error('Init failed:', error);
                showError(`System Error: ${error.message}`);
            }
        };

        // ðŸŽ¬ æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•
        $(document).ready(async () => {
            try {
                await waitForChart();
                console.log('ðŸ“¡ Chart.js loaded successfully');
                await initApp();
            } catch (error) {
                showError(`Boot Error: ${error.message}`);
            }
            
            $(window).on('beforeunload', cleanup);
            
            window.addEventListener('error', (event) => {
                console.error('ðŸ’¥ Runtime Error:', event.error);
                showError('Runtime exception detected. Please refresh.');
            });
        });
    </script>
</body>

</html>
</html>