<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%- title.replace(/</g, '&lt;').replace(/>/g, '&gt;') %> <%= version %></title>
    
    <!-- Bootstrap 5 CSS -->
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    
    <!-- DataTables Bootstrap 5 CSS -->
    <link rel="stylesheet" href="./css/datatables.bootstrap5.min.css">
    
    <!-- 自訂 CSS -->
    <link rel="stylesheet" href="./css/style.css">
</head>

<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="container">
            <!-- 主標題 -->
            <div class="row mb-5">
                <div class="col-12 text-center">
                    <h1 class="display-4 fw-light text-primary">
                        <%- title.replace(/</g, '&lt;').replace(/>/g, '&gt;') %> <%= version %>
                    </h1>
                </div>
            </div>
            
            <!-- 第一組數據 - GitHub 星星成長最快專案 -->
            <div class="row mb-5">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white text-center">
                            <h2 class="card-title mb-0 h4">GitHub 星星成長最快專案 (前20名)</h2>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-lg-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <h5 class="card-title mb-0">專案追蹤人數</h5>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center">
                                            <div id="loading1" class="text-muted">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">載入中...</span>
                                                </div>
                                                <div class="mt-2">載入中...</div>
                                            </div>
                                            <div class="chart-wrapper w-100" style="height: 400px;">
                                                <canvas id="chart1" style="display: none;"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-lg-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <h5 class="card-title mb-0">資料表格</h5>
                                        </div>
                                        <div class="card-body">
                                            <table id="dataTable1" class="table table-striped table-hover" style="width:100%">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>專案名稱</th>
                                                        <th>星星數</th>
                                                        <th>每日成長</th>
                                                        <th>程式語言</th>
                                                        <th>連結</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- 資料將由 JavaScript 動態載入 -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 第二組數據 - GitHub 最受歡迎專案 -->
            <div class="row mb-5">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white text-center">
                            <h2 class="card-title mb-0 h4">GitHub 最受歡迎專案 (前30名)</h2>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-lg-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <h5 class="card-title mb-0">星星數</h5>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center">
                                            <div id="loading2" class="text-muted">
                                                <div class="spinner-border text-success" role="status">
                                                    <span class="visually-hidden">載入中...</span>
                                                </div>
                                                <div class="mt-2">載入中...</div>
                                            </div>
                                            <div class="chart-wrapper w-100" style="height: 400px;">
                                                <canvas id="chart2" style="display: none;"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-lg-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <h5 class="card-title mb-0">資料表格</h5>
                                        </div>
                                        <div class="card-body">
                                            <table id="dataTable2" class="table table-striped table-hover" style="width:100%">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>排名</th>
                                                        <th>專案名稱</th>
                                                        <th>星星數</th>
                                                        <th>程式語言</th>
                                                        <th>連結</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- 資料將由 JavaScript 動態載入 -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引用本地 JavaScript 檔案 -->
    <script src="./js/jquery.min.js"></script>
    <script src="./js/bootstrap.bundle.min.js"></script>
    <script src="./js/datatables.min.js"></script>
    <script src="./js/datatables.bootstrap5.min.js"></script>
    <script src="./js/chart.umd.min.js"></script>
    
    <script>
    /* 主程式架構
    class DualChartTable {
        // 1. 建構函數 - 初始化所有變數
        constructor() { ... }
        
        // 2. 圖表建立方法
        createChart = (chartId, type, data, colors) => { ... }
        
        // 3. 資料表初始化方法  
        initDataTable = (tableId, data, columns) => { ... }
        
        // 4. 資料載入方法
        loadData1 = async () => { ... }  // 第一組資料
        loadData2 = async () => { ... }  // 第二組資料
    }

    // 5. 應用程式初始化
    $(() => {
        const app = new DualChartTable();
        app.loadData1();
        app.loadData2();
    });
    */

        // 雙數據圖表和資料表管理
        class DualChartTable {
            constructor() {
                this.chart1 = null;
                this.chart2 = null;
                this.dataTable1 = null;
                this.dataTable2 = null;
                this.data1 = [];
                this.data2 = [];
            }
            
            // 建立圖表
            createChart = (chartId, type, data, colors) => {
                const ctx = $(`#${chartId}`)[0].getContext('2d');
                
                // 銷毀現有圖表
                if (chartId === 'chart1' && this.chart1) {
                    this.chart1.destroy();
                } else if (chartId === 'chart2' && this.chart2) {
                    this.chart2.destroy();
                }
                
                const chartInstance = new Chart(ctx, {
                    type: type,
                    data: {
                        labels: data.map(item => item.label),
                        datasets: [{
                            label: '數值',
                            data: data.map(item => item.value),
                            backgroundColor: type === 'bar' 
                                ? colors.slice(0, data.length)
                                : colors[0] + '33',
                            borderColor: type === 'bar' 
                                ? colors.slice(0, data.length)
                                : colors[0],
                            borderWidth: 2,
                            fill: type === 'line' ? false : true,
                            tension: type === 'line' ? 0.4 : 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
                
                // 儲存圖表實例
                if (chartId === 'chart1') {
                    this.chart1 = chartInstance;
                } else {
                    this.chart2 = chartInstance;
                }
            }
            
            // 初始化 DataTable
            initDataTable = (tableId, data, columns) => {
                // 銷毀現有的 DataTable
                if (tableId === 'dataTable1' && this.dataTable1) {
                    this.dataTable1.destroy();
                    $(`#${tableId} tbody`).empty();
                } else if (tableId === 'dataTable2' && this.dataTable2) {
                    this.dataTable2.destroy();
                    $(`#${tableId} tbody`).empty();
                }
                
                let tableData;
                if (tableId === 'dataTable1') {
                    // GitHub 星星成長最快專案的資料格式
                    tableData = data.map(item => [
                        item.label,
                        item.value.toLocaleString(),
                        `${item.starsPerDay}/天`,
                        item.language,
                        `<a href="${item.url}" target="_blank" class="btn btn-sm btn-outline-primary">查看</a>`
                    ]);
                } else {
                    // GitHub 最受歡迎專案的資料格式
                    tableData = data.map(item => [
                        item.rank,
                        item.name,
                        item.stars.toLocaleString(),
                        item.language,
                        `<a href="${item.url}" target="_blank" class="btn btn-sm btn-outline-primary">查看</a>`
                    ]);
                }
                
                const tableInstance = $(`#${tableId}`).DataTable({
                    data: tableData,
                    columns: columns,
                    pageLength: 5,
                    lengthMenu: [[5, 10, 20, -1], [5, 10, 20, "全部"]],
                    searching: true,
                    ordering: true,
                    info: true,
                    language: {
                        search: "搜尋:",
                        lengthMenu: "顯示 _MENU_ 筆資料",
                        info: "顯示第 _START_ 到 _END_ 筆資料，共 _TOTAL_ 筆",
                        paginate: {
                            first: "首頁",
                            last: "末頁", 
                            next: "下一頁",
                            previous: "上一頁"
                        }
                    },
                    order: tableId === 'dataTable1' ? [[2, 'desc']] : [[2, 'desc']], // 按星星數排序
                    columnDefs: [
                        { targets: -1, orderable: false } // 連結欄位不可排序
                    ]
                });
                
                // 儲存 DataTable 實例
                if (tableId === 'dataTable1') {
                    this.dataTable1 = tableInstance;
                } else {
                    this.dataTable2 = tableInstance;
                }
            }
            
            // 載入第一組資料
            loadData1 = async () => {
                try {
                    const response = await fetch('/api/chart-data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();

                        if (result.status === 'success') {
                            this.data1 = result.data;
                            
                            $('#loading1').fadeOut(300, () => {
                                $('#chart1').fadeIn(500);
                            });
                            
                            const colors1 = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#e67e22'];
                            this.createChart('chart1', 'bar', this.data1, colors1);
                            
                            const columns1 = [
                                { title: "專案名稱" },
                                { title: "星星數" },
                                { title: "每日成長" },
                                { title: "程式語言" },
                                { title: "連結" }
                            ];
                            this.initDataTable('dataTable1', this.data1, columns1);
                        }
                    } else {
                        console.error('API 回應錯誤:', response.status);
                        $('#loading1').html('<div class="text-danger">載入失敗</div>');
                    }
                } catch (error) {
                    console.error('GitHub 成長專案資料載入失敗:', error);
                    $('#loading1').html('<div class="text-danger">載入失敗</div>');
                }
            }
            
            // 載入第二組資料
            loadData2 = async () => {
                try {
                    const response = await fetch('/api/popular-repos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 'success') {
                            this.data2 = result.data;
                            
                            $('#loading2').fadeOut(300, () => {
                                $('#chart2').fadeIn(500);
                            });
                            
                            // 為圖表準備資料（取前10名顯示）
                            const chartData = this.data2.slice(0, 10).map(item => ({
                                label: item.name,
                                value: item.stars,
                                percentage: 0 // 不需要百分比
                            }));
                            
                            const colors2 = ['#8e44ad', '#27ae60', '#e67e22', '#34495e', '#f39c12', '#95a5a6', '#e74c3c', '#3498db', '#f1c40f', '#2ecc71'];
                            this.createChart('chart2', 'bar', chartData, colors2);
                            
                            const columns2 = [
                                { title: "排名" },
                                { title: "專案名稱" },
                                { title: "星星數" },
                                { title: "程式語言" },
                                { title: "連結" }
                            ];
                            this.initDataTable('dataTable2', this.data2, columns2);
                        }
                    } else {
                        console.error('API 回應錯誤:', response.status);
                        $('#loading2').html('<div class="text-danger">載入失敗</div>');
                    }
                } catch (error) {
                    console.error('GitHub 熱門專案資料載入失敗:', error);
                    $('#loading2').html('<div class="text-danger">載入失敗</div>');
                }
            }
            
        }
        
        // 初始化
        $(() => {
            const app = new DualChartTable();
            
            // 載入兩組資料
            app.loadData1();
            app.loadData2();
            
        });
    </script>
</body>
</html>